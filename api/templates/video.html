{% extends "base.html" %}

{% block title %}视频处理{% endblock %}

{% block content %}
<h1>视频处理</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">上传并处理视频</h5>
                <form id="processVideoForm">
                    <div class="mb-3">
                        <label for="file_id" class="form-label">文件ID</label>
                        <input type="text" class="form-control" id="file_id" name="file_id" placeholder="请输入已上传视频的文件ID">
                        <div class="form-text">请先通过首页上传视频文件获取文件ID</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="detect_loitering" name="detect_loitering" checked>
                        <label class="form-check-label" for="detect_loitering">检测徘徊行为</label>
                    </div>
                    <div class="mb-3">
                        <label for="loitering_time_threshold" class="form-label">徘徊时间阈值 (秒)</label>
                        <input type="number" class="form-control" id="loitering_time_threshold" name="loitering_time_threshold" value="20" min="1">
                    </div>
                    <button type="submit" class="btn btn-primary" id="processVideoBtn">处理视频</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">处理状态</h5>
                <div id="statusContainer">
                    <p class="text-muted">处理状态将显示在这里</p>
                </div>
                <div class="mt-3">
                    <button id="checkStatusBtn" class="btn btn-secondary" disabled>检查状态</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">处理结果</h5>
                <div id="resultContainer">
                    <p class="text-muted">处理结果将显示在这里</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;

document.getElementById('processVideoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // 禁用按钮并显示加载状态
    const btn = document.getElementById('processVideoBtn');
    btn.disabled = true;
    btn.textContent = '处理中...';
    
    fetch('/api/process_video', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('statusContainer').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            currentTaskId = data.task_id;
            document.getElementById('statusContainer').innerHTML = `
                <div class="alert alert-info">
                    <p>视频处理已启动!</p>
                    <p>任务ID: ${data.task_id}</p>
                    <p>消息: ${data.message}</p>
                </div>
            `;
            document.getElementById('checkStatusBtn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('statusContainer').innerHTML = '<div class="alert alert-danger">处理过程中发生错误</div>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = '处理视频';
    });
});

document.getElementById('checkStatusBtn').addEventListener('click', function() {
    if (!currentTaskId) {
        alert('请先启动视频处理任务');
        return;
    }
    
    fetch(`/api/task_status/${currentTaskId}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('statusContainer');
        if (data.error) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            let html = `
                <div class="alert alert-info">
                    <p>状态: ${data.status}</p>
            `;
            
            if (data.progress !== undefined) {
                html += `<p>进度: ${data.progress}%</p>`;
            }
            
            if (data.result_path) {
                html += `<p>结果路径: ${data.result_path}</p>`;
            }
            
            if (data.frame_count) {
                html += `<p>处理帧数: ${data.frame_count}</p>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // 如果任务已完成，显示下载链接
            if (data.status === 'completed') {
                document.getElementById('resultContainer').innerHTML = `
                    <div class="alert alert-success">
                        <p>视频处理完成!</p>
                        <a href="${data.result_path}" class="btn btn-success" download>下载处理后的视频</a>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('statusContainer').innerHTML = '<div class="alert alert-danger">检查状态时发生错误</div>';
    });
});
</script>
{% endblock %}