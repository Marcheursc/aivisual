{% extends "base.html" %}

{% block title %}对象检测{% endblock %}

{% block content %}
<h1>对象检测</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">视频上传与检测选择</h5>
                <form id="detectionForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="video" class="form-label">选择视频文件</label>
                        <input class="form-control" type="file" id="video" name="video" accept="video/*" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">选择检测类型</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="detectionType" id="loitering" value="loitering" checked>
                                <label class="form-check-label" for="loitering">
                                    徘徊检测
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="detectionType" id="gather" value="gather">
                                <label class="form-check-label" for="gather">
                                    聚集检测
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="detectionType" id="leave" value="leave">
                                <label class="form-check-label" for="leave">
                                    离岗检测
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="loiteringOptions">
                        <label for="loiteringTimeThreshold" class="form-label">徘徊时间阈值 (秒)</label>
                        <input type="number" class="form-control" id="loiteringTimeThreshold" name="loitering_time_threshold" value="20" min="1">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="startDetectionBtn">开始检测</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">检测状态</h5>
                <div id="statusContainer">
                    <p class="text-muted">检测状态将显示在这里</p>
                </div>
                <div class="mt-3">
                    <button id="checkStatusBtn" class="btn btn-secondary" disabled>检查状态</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">检测结果</h5>
                <div id="resultContainer">
                    <p class="text-muted">检测结果将显示在这里</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;

// 根据选择的检测类型显示/隐藏选项
document.querySelectorAll('input[name="detectionType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.value === 'loitering') {
            document.getElementById('loiteringOptions').style.display = 'block';
        } else {
            document.getElementById('loiteringOptions').style.display = 'none';
        }
    });
});

document.getElementById('detectionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // 禁用按钮并显示加载状态
    const btn = document.getElementById('startDetectionBtn');
    btn.disabled = true;
    btn.textContent = '检测中...';
    
    fetch('/api/simple_detect', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('statusContainer').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            currentTaskId = data.task_id;
            document.getElementById('statusContainer').innerHTML = `
                <div class="alert alert-info">
                    <p>视频检测已启动!</p>
                    <p>任务ID: ${data.task_id}</p>
                    <p>消息: ${data.message}</p>
                </div>
            `;
            document.getElementById('checkStatusBtn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('statusContainer').innerHTML = '<div class="alert alert-danger">检测过程中发生错误</div>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = '开始检测';
    });
});

document.getElementById('checkStatusBtn').addEventListener('click', function() {
    if (!currentTaskId) {
        alert('请先启动检测任务');
        return;
    }
    
    fetch(`/api/task_status/${currentTaskId}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('statusContainer');
        if (data.error) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            let html = `
                <div class="alert alert-info">
                    <p>状态: ${data.status}</p>
            `;
            
            if (data.progress !== undefined) {
                html += `<p>进度: ${data.progress}%</p>`;
            }
            
            if (data.result_path) {
                html += `<p>结果路径: ${data.result_path}</p>`;
            }
            
            if (data.frame_count) {
                html += `<p>处理帧数: ${data.frame_count}</p>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // 如果任务已完成，显示下载链接
            if (data.status === 'completed') {
                document.getElementById('resultContainer').innerHTML = `
                    <div class="alert alert-success">
                        <p>视频检测完成!</p>
                        <a href="${data.result_path}" class="btn btn-success" download>下载处理后的视频</a>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('statusContainer').innerHTML = '<div class="alert alert-danger">检查状态时发生错误</div>';
    });
});
</script>
{% endblock %}